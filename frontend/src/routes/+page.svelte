<script lang="ts">
	import { onMount, tick } from 'svelte';
	import { getApiUrl } from '$lib/config';
	
	interface Job {
		job_id: string;
		status: string;
		progress: number;
		message?: string;
		result_url?: string;
		error?: string;
	}

	interface DialogueData {
		[key: string]: Array<{
			speaker: string;
			text: string;
		}>;
	}

	interface Slide {
		slide_number: number;
		url: string;
	}

	interface DialogueResponse {
		dialogue_data: DialogueData;
		estimated_duration: {
			seconds: number;
			formatted: string;
		};
	}

	let selectedFile: File | null = null;
	let currentJob: Job | null = null;
	let isUploading = false;
	let dragover = false;
	let dialogueData: DialogueData | null = null;
	let estimatedDuration: { seconds: number; formatted: string } | null = null;
	let editingDialogue = false;
	let additionalPrompt = '';
	let currentStep: 'upload' | 'dialogue' | 'video' = 'upload';
	let slides: Slide[] = [];
	let isRegenerating = false;
	let instructionHistory: any = {};
	let showHistory = false;
	let showHistoryForSlide: string | null = null;
	let targetDuration = 10; // デフォルト10分
	let availableSpeakers: any[] = [];
	let selectedSpeaker1Id = 2;
	let selectedSpeaker2Id = 3;
	let speakersLoading = false;
	let showRecommendations = false;
	let playingSampleId: number | null = null;
	let currentJobMetadata: any = null; // 現在のジョブのメタデータ
	
	// ビジネス向けおすすめ組み合わせ
	const businessRecommendations = [
		{
			name: '最もプロフェッショナル',
			description: '企業向けプレゼンや研修動画に最適',
			speaker1: { id: 13, name: '青山龍星' },
			speaker2: { id: 16, name: '九州そら' }
		},
		{
			name: 'バランス型',
			description: '幅広いビジネスシーンに対応',
			speaker1: { id: 11, name: '玄野武宏' },
			speaker2: { id: 8, name: '春日部つむぎ' }
		},
		{
			name: '若手向け',
			description: 'スタートアップや若手向けコンテンツに',
			speaker1: { id: 14, name: '冥鳴ひまり' },
			speaker2: { id: 12, name: '白上虎太郎' }
		}
	];
	
	async function loadSpeakers() {
		speakersLoading = true;
		try {
			const response = await fetch(getApiUrl('/api/speakers'));
			if (response.ok) {
				availableSpeakers = await response.json();
			}
		} catch (error) {
			console.error('スピーカー一覧の取得に失敗:', error);
		} finally {
			speakersLoading = false;
		}
	}

	onMount(() => {
		loadSpeakers();
	});
	
	function applyRecommendation(recommendation: any) {
		selectedSpeaker1Id = recommendation.speaker1.id;
		selectedSpeaker2Id = recommendation.speaker2.id;
		showRecommendations = false;
	}
	
	async function playVoiceSample(speakerId: number, speakerName: string) {
		try {
			playingSampleId = speakerId;
			
			const sampleText = speakerName === 'ずんだもん' 
				? 'こんにちは！ずんだもんなのだ！' 
				: `こんにちは！${speakerName}です。よろしくお願いします。`;
			
			const response = await fetch(getApiUrl('/api/voice-sample'), {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					speaker_id: speakerId,
					text: sampleText
				})
			});
			
			if (response.ok) {
				const blob = await response.blob();
				const audioUrl = URL.createObjectURL(blob);
				const audio = new Audio(audioUrl);
				
				await audio.play();
				
				// メモリリークを防ぐためにURLを解放
				audio.addEventListener('ended', () => {
					URL.revokeObjectURL(audioUrl);
					playingSampleId = null;
				});
			} else {
				playingSampleId = null;
			}
		} catch (error) {
			console.error('サンプルボイスの再生に失敗:', error);
			playingSampleId = null;
		}
	}

	async function handleFileSelect(event: Event) {
		const target = event.target as HTMLInputElement;
		if (target.files && target.files[0]) {
			selectedFile = target.files[0];
		}
	}

	async function handleDrop(event: DragEvent) {
		event.preventDefault();
		dragover = false;
		
		const files = event.dataTransfer?.files;
		if (files && files[0]) {
			selectedFile = files[0];
		}
	}

	async function uploadAndGenerate() {
		if (!selectedFile) return;

		isUploading = true;
		try {
			const formData = new FormData();
			formData.append('file', selectedFile);
			formData.append('target_duration', targetDuration.toString());
			// 選択されたスピーカー情報を取得
			const speaker1 = availableSpeakers.find(s => s.style_id === selectedSpeaker1Id);
			const speaker2 = availableSpeakers.find(s => s.style_id === selectedSpeaker2Id);
			
			formData.append('speaker1_id', selectedSpeaker1Id.toString());
			formData.append('speaker1_name', speaker1 ? speaker1.speaker_name : '四国めたん');
			formData.append('speaker2_id', selectedSpeaker2Id.toString());
			formData.append('speaker2_name', speaker2 ? speaker2.speaker_name : 'ずんだもん');

			const response = await fetch(getApiUrl('/api/jobs/upload'), {
				method: 'POST',
				body: formData
			});

			if (!response.ok) {
				throw new Error('アップロードに失敗しました');
			}

			const result = await response.json();
			currentJob = {
				job_id: result.job_id,
				status: 'processing',
				progress: 0
			};

			// ステータス監視開始（対話生成は既にサーバー側で行われる）
			// currentStepは自動的に更新される
			pollJobStatus(result.job_id);
			
		} catch (error) {
			console.error('エラー:', error);
			alert('アップロードに失敗しました');
		} finally {
			isUploading = false;
		}
	}

	async function generateDialogue(jobId: string, regenerate = false) {
		try {
			if (regenerate) {
				console.log('再生成開始:', { 
					jobId, 
					additionalPrompt,
					currentJobStatus: currentJob?.status,
					isRegenerating
				});
				isRegenerating = true;
				await tick(); // UIの更新を強制
			}
			
			const response = await fetch(getApiUrl(`/api/jobs/${jobId}/generate-dialogue`), {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					job_id: jobId,
					additional_prompt: regenerate ? additionalPrompt : null
				})
			});

			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.detail || '対話生成開始に失敗しました');
			}

			// 進捗監視開始
			pollJobStatus(jobId);
			
		} catch (error) {
			console.error('エラー:', error);
			alert(error.message || '対話生成に失敗しました');
			if (currentJob) {
				currentJob.error = error.message || '対話生成に失敗しました';
			}
			isRegenerating = false;
		}
	}

	async function startVideoGeneration(jobId: string) {
		try {
			// 対話データがあれば必ず保存（編集された可能性があるため）
			if (dialogueData) {
				await updateDialogue(jobId);
			}

			const response = await fetch(getApiUrl(`/api/jobs/${jobId}/generate-video`), {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				}
			});

			if (!response.ok) {
				throw new Error('動画生成開始に失敗しました');
			}

			currentStep = 'video';
			// 進捗監視開始
			pollJobStatus(jobId);
			
		} catch (error) {
			console.error('エラー:', error);
			if (currentJob) {
				currentJob.error = '動画生成に失敗しました';
			}
		}
	}

	async function loadDialogue(jobId: string, forceReload = false) {
		try {
			console.log('対話データ読み込み開始:', { jobId, forceReload, isRegenerating });
			
			// キャッシュを無効化するためのタイムスタンプを追加
			const timestamp = forceReload || isRegenerating ? `?t=${Date.now()}` : '';
			
			// 対話データを取得
			const dialogueResponse = await fetch(getApiUrl(`/api/jobs/${jobId}/dialogue${timestamp}`));
			if (!dialogueResponse.ok) {
				console.error('対話データ取得失敗:', dialogueResponse.status);
				return;
			}

			const dialogueResult: DialogueResponse = await dialogueResponse.json();
			console.log('Raw dialogueResult:', dialogueResult);
			console.log('dialogue_data keys before assignment:', Object.keys(dialogueResult.dialogue_data));
			
			// Svelteの反応性を確実にするため、新しいオブジェクトとして割り当て
			dialogueData = { ...dialogueResult.dialogue_data };
			estimatedDuration = dialogueResult.estimated_duration;
			
			// デバッグ用ログ
			console.log('対話データ取得成功:', Object.keys(dialogueData).length + 'スライド');
			console.log('推定動画時間:', estimatedDuration?.formatted);
			console.log('dialogueData after assignment:', dialogueData);
			console.log('dialogueData keys:', Object.keys(dialogueData));
			
			// スライド画像も取得
			const slidesResponse = await fetch(getApiUrl(`/api/jobs/${jobId}/slides${timestamp}`));
			if (slidesResponse.ok) {
				slides = await slidesResponse.json();
				console.log('スライド画像取得成功:', slides.length + '枚');
			}
			
			// 指示履歴も取得
			await loadInstructionHistory(jobId);
			
			// メタデータも取得
			await loadJobMetadata(jobId);
			
			currentStep = 'dialogue';
			console.log('currentStep更新:', currentStep);
			
			// 強制的にUIを更新
			await tick();
		} catch (error) {
			console.error('対話データ取得エラー:', error);
		}
	}

	async function loadInstructionHistory(jobId: string) {
		try {
			const response = await fetch(getApiUrl(`/api/jobs/${jobId}/instruction-history`));
			if (response.ok) {
				const data = await response.json();
				instructionHistory = data.history || {};
				console.log('指示履歴取得成功:', instructionHistory);
			}
		} catch (error) {
			console.error('指示履歴取得エラー:', error);
		}
	}

	async function loadJobMetadata(jobId: string) {
		try {
			const response = await fetch(getApiUrl(`/api/jobs/${jobId}/metadata`));
			if (response.ok) {
				currentJobMetadata = await response.json();
				console.log('メタデータ取得成功:', currentJobMetadata);
			}
		} catch (error) {
			console.error('メタデータ取得エラー:', error);
		}
	}

	async function updateDialogue(jobId: string) {
		try {
			const response = await fetch(getApiUrl(`/api/jobs/${jobId}/dialogue`), {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({
					job_id: jobId,
					dialogue_data: dialogueData
				})
			});

			if (!response.ok) {
				throw new Error('対話データ更新に失敗しました');
			}
		} catch (error) {
			console.error('対話データ更新エラー:', error);
		}
	}

	async function pollJobStatus(jobId: string) {
		console.log('ポーリング開始:', { jobId, currentStep });
		const poll = async () => {
			try {
				const response = await fetch(getApiUrl(`/api/jobs/${jobId}/status`));
				if (!response.ok) return;

				const job = await response.json();
				currentJob = job;
				console.log('ジョブステータス:', {
					status: job.status,
					progress: job.progress,
					message: job.message,
					dialogueData: !!dialogueData,
					currentStep
				});

				if (job.status === 'dialogue_ready' || job.status === 'slides_ready') {
					if (!dialogueData || isRegenerating) {
						console.log(`${job.status}検知、対話データ読み込み開始 (再生成: ${isRegenerating})`);
						// 対話データを読み込む
						await loadDialogue(jobId, true);  // 強制リロード
						isRegenerating = false;
						return; // ポーリング停止
					}
				} else if (job.status === 'completed' || job.status === 'failed') {
					console.log('処理完了/失敗:', job.status);
					isRegenerating = false;
					return; // 完了
				}

				// dialogue編集画面では、generating_dialogue以外はポーリング不要
				if (currentStep === 'dialogue' && job.status !== 'generating_dialogue') {
					return;
				}

				// 3秒後に再試行
				setTimeout(poll, 3000);
			} catch (error) {
				console.error('ステータス取得エラー:', error);
			}
		};

		poll();
	}

	function resetForm() {
		selectedFile = null;
		currentJob = null;
		isUploading = false;
		dialogueData = null;
		estimatedDuration = null;
		editingDialogue = false;
		additionalPrompt = '';
		currentStep = 'upload';
		isRegenerating = false;
		showHistoryForSlide = null;
		targetDuration = 10; // デフォルトに戻す
	}

	function addDialogueItem(slideKey: string) {
		if (!dialogueData) return;
		// 最後の発話者と逆のスピーカーを選択
		const lastSpeaker = dialogueData[slideKey].length > 0 
			? dialogueData[slideKey][dialogueData[slideKey].length - 1].speaker
			: 'speaker2';
		const nextSpeaker = lastSpeaker === 'speaker1' ? 'speaker2' : 'speaker1';
		
		dialogueData[slideKey] = [
			...dialogueData[slideKey],
			{ speaker: nextSpeaker, text: '' }
		];
	}

	function removeDialogueItem(slideKey: string, index: number) {
		if (!dialogueData) return;
		dialogueData[slideKey] = dialogueData[slideKey].filter((_, i) => i !== index);
	}

	function toggleSlideHistory(slideKey: string) {
		if (showHistoryForSlide === slideKey) {
			showHistoryForSlide = null;
		} else {
			showHistoryForSlide = slideKey;
		}
	}

	async function downloadCSV(jobId: string) {
		try {
			const response = await fetch(getApiUrl(`/api/jobs/${jobId}/dialogue/csv`));
			if (!response.ok) {
				throw new Error('CSVダウンロードに失敗しました');
			}
			
			const blob = await response.blob();
			const url = window.URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `dialogue_${jobId}.csv`;
			document.body.appendChild(a);
			a.click();
			window.URL.revokeObjectURL(url);
			document.body.removeChild(a);
		} catch (error) {
			console.error('CSVダウンロードエラー:', error);
			alert('CSVダウンロードに失敗しました');
		}
	}

	async function handleCSVUpload(event: Event) {
		const target = event.target as HTMLInputElement;
		if (!target.files || !target.files[0] || !currentJob) return;
		
		const file = target.files[0];
		const formData = new FormData();
		formData.append('file', file);
		
		try {
			const response = await fetch(getApiUrl(`/api/jobs/${currentJob.job_id}/dialogue/csv`), {
				method: 'POST',
				body: formData
			});
			
			if (!response.ok) {
				const error = await response.json();
				throw new Error(error.detail || 'CSVアップロードに失敗しました');
			}
			
			const result = await response.json();
			alert(`${result.message}`);
			
			// 対話データを再読み込み
			await loadDialogue(currentJob.job_id, true);
			
		} catch (error) {
			console.error('CSVアップロードエラー:', error);
			alert(error.message || 'CSVアップロードに失敗しました');
		} finally {
			// ファイル選択をリセット
			target.value = '';
		}
	}
</script>

<svelte:head>
	<title>PDF to Video Generator</title>
</svelte:head>

<main class="container">
	<header>
		<h1>🎬 PDF to Video Generator</h1>
		<p>PDFスライドからVOICEVOXキャラクターによる対話動画を自動生成</p>
	</header>

	{#if currentStep === 'upload' && !currentJob}
		<section class="upload-section">
			{#if !selectedFile}
				<div 
					class="dropzone" 
					class:dragover
					role="button"
					tabindex="0"
					on:dragover|preventDefault={() => dragover = true}
					on:dragleave={() => dragover = false}
					on:drop={handleDrop}
				>
					<div class="drop-content">
						<div class="upload-icon">📁</div>
						<h3>PDFファイルをアップロード</h3>
						<p>ドラッグ&ドロップまたはクリックしてファイルを選択</p>
						
						<input 
							type="file" 
							accept=".pdf" 
							on:change={handleFileSelect}
							class="file-input"
							id="file-input"
						/>
						<label for="file-input" class="file-label">
							ファイルを選択
						</label>
					</div>
				</div>
			{/if}

			{#if selectedFile}
				<div class="file-info">
					<div class="file-details">
						<strong>選択ファイル:</strong> {selectedFile.name}
						<br>
						<strong>サイズ:</strong> {(selectedFile.size / 1024 / 1024).toFixed(2)} MB
					</div>
					
					<div class="duration-setting">
						<label for="target-duration">目安動画時間:</label>
						<input 
							type="number" 
							id="target-duration"
							bind:value={targetDuration}
							min="1"
							max="60"
							step="1"
						/>
						<span>分</span>
					</div>

					<div class="speaker-settings">
						<h4>キャラクター設定</h4>
						<button 
							class="recommendation-toggle" 
							on:click={() => showRecommendations = !showRecommendations}
							disabled={playingSampleId !== null}
						>
							💼 ビジネス向けおすすめを見る
						</button>
						
						{#if showRecommendations}
							<div class="recommendations">
								<h5>ビジネス向けおすすめ組み合わせ</h5>
								{#each businessRecommendations as rec}
									<div class="recommendation-item">
										<div class="rec-header">
											<strong>{rec.name}</strong>
											<button 
												class="apply-btn" 
												on:click={() => applyRecommendation(rec)}
												disabled={playingSampleId !== null}
											>
												この組み合わせを使う
											</button>
										</div>
										<p class="rec-description">{rec.description}</p>
										<p class="rec-speakers">
											説明役: {rec.speaker1.name} / 聞き役: {rec.speaker2.name}
										</p>
									</div>
								{/each}
							</div>
						{/if}
						
						{#if speakersLoading}
							<p>読み込み中...</p>
						{:else}
							<div class="speaker-row">
								<label for="speaker1">話者1（説明役）:</label>
								<select 
									id="speaker1" 
									bind:value={selectedSpeaker1Id}
									disabled={playingSampleId !== null}
								>
									{#each availableSpeakers as speaker}
										<option value={speaker.style_id}>
											{speaker.display_name}
										</option>
									{/each}
								</select>
								<button 
									class="sample-btn" 
									class:loading={playingSampleId === selectedSpeaker1Id}
									on:click={() => {
										const speaker = availableSpeakers.find(s => s.style_id === selectedSpeaker1Id);
										if (speaker) playVoiceSample(selectedSpeaker1Id, speaker.speaker_name);
									}}
									disabled={playingSampleId !== null}
									title="サンプルボイスを再生"
								>
									{#if playingSampleId === selectedSpeaker1Id}
										<span class="spinner"></span>
									{:else}
										🔊
									{/if}
								</button>
							</div>
							<div class="speaker-row">
								<label for="speaker2">話者2（聞き役）:</label>
								<select 
									id="speaker2" 
									bind:value={selectedSpeaker2Id}
									disabled={playingSampleId !== null}
								>
									{#each availableSpeakers as speaker}
										<option value={speaker.style_id}>
											{speaker.display_name}
										</option>
									{/each}
								</select>
								<button 
									class="sample-btn" 
									class:loading={playingSampleId === selectedSpeaker2Id}
									on:click={() => {
										const speaker = availableSpeakers.find(s => s.style_id === selectedSpeaker2Id);
										if (speaker) playVoiceSample(selectedSpeaker2Id, speaker.speaker_name);
									}}
									disabled={playingSampleId !== null}
									title="サンプルボイスを再生"
								>
									{#if playingSampleId === selectedSpeaker2Id}
										<span class="spinner"></span>
									{:else}
										🔊
									{/if}
								</button>
							</div>
						{/if}
					</div>
					
					<button 
						class="generate-btn" 
						on:click={uploadAndGenerate}
						disabled={isUploading || playingSampleId !== null}
					>
						{isUploading ? '処理中...' : '📝 対話スクリプト生成'}
					</button>
					
					<button class="reset-btn" on:click={resetForm}>
						リセット
					</button>
				</div>
			{/if}
		</section>
	{:else if currentStep === 'dialogue' && dialogueData}
		<section class="dialogue-section">
			<h3>📝 対話スクリプト編集</h3>
			
			{#if estimatedDuration}
				<div class="duration-estimate">
					<span class="duration-icon">⏱️</span>
					<span class="duration-text">推定動画時間: <strong>{estimatedDuration.formatted}</strong></span>
				</div>
			{/if}
			
			<div class="dialogue-controls">
				<button class="edit-btn" on:click={() => editingDialogue = !editingDialogue}>
					{editingDialogue ? '編集を終了' : '✏️ スクリプトを編集'}
				</button>
				<button class="csv-download-btn" on:click={() => currentJob && downloadCSV(currentJob.job_id)}>
					📥 CSVダウンロード
				</button>
				<button class="csv-upload-btn" on:click={() => document.getElementById('csv-upload-input')?.click()}>
					📤 CSVアップロード
				</button>
				<input
					id="csv-upload-input"
					type="file"
					accept=".csv"
					style="display: none"
					on:change={handleCSVUpload}
				/>
				<button class="generate-btn" on:click={() => currentJob && startVideoGeneration(currentJob.job_id)}>
					🎥 動画生成開始
				</button>
			</div>

			{#if editingDialogue}
				<div class="edit-notice">
					<span class="notice-icon">⚠️</span>
					<span class="notice-text">
						<strong>編集時の注意：</strong>英単語はカタカナで入力してください。
						アルファベットのまま入力すると音声生成時に正しく読み上げられない場合があります。
						<br>
						例: API → エーピーアイ、Claude → クロード、AI → エーアイ
					</span>
				</div>
			{/if}

			<div class="additional-prompt-section">
				<label for="additional-prompt">AIへの追加指示（再生成時に使用）:</label>
				<textarea 
					id="additional-prompt"
					bind:value={additionalPrompt}
					placeholder="例: 1枚目のスライドをもっとカジュアルに / 全体的に初心者向けに / 最初と最後のスライドを修正"
					rows="3"
					disabled={isRegenerating}
				></textarea>
				<button 
					class="regenerate-btn" 
					on:click={() => currentJob && generateDialogue(currentJob.job_id, true)}
					disabled={currentJob?.status === 'generating_dialogue' || isRegenerating || !additionalPrompt.trim()}
				>
					{isRegenerating ? '⏳ 再生成中...' : '🔄 スクリプト再生成'}
				</button>
				{#if isRegenerating && currentJob}
					<div class="regeneration-status">
						<div class="status-message">🤖 {currentJob.message || 'AIが修正対象を判断中...'}</div>
						<div class="progress-bar">
							<div class="progress-fill" style="width: {currentJob.progress}%"></div>
						</div>
					</div>
				{/if}
			</div>

			<div class="dialogue-list">
				{#each Object.entries(dialogueData) as [slideKey, dialogues]}
					{@const slideNum = parseInt(slideKey.split('_')[1])}
					{@const slideHistory = instructionHistory[slideKey] || []}
					<div class="slide-dialogue">
						<div class="slide-header">
							{#if slides.length > 0}
								{@const slide = slides.find(s => s.slide_number === slideNum)}
								{#if slide}
									<img src={getApiUrl(slide.url)} alt="Slide {slideNum}" class="slide-thumbnail" />
								{/if}
							{/if}
							<h4>{slideKey.replace('slide_', 'スライド')}</h4>
							{#if slideHistory.length > 0}
								<button 
									class="history-toggle"
									on:click={() => toggleSlideHistory(slideKey)}
									title="指示履歴を表示"
								>
									📝 履歴 ({slideHistory.length})
								</button>
							{/if}
						</div>
						{#if showHistoryForSlide === slideKey}
							<div class="instruction-history">
								<h5>再生成指示履歴:</h5>
								{#each slideHistory as hist, idx}
									<div class="history-item">
										<div class="history-timestamp">
											{new Date(hist.timestamp).toLocaleString('ja-JP')}
										</div>
										<div class="history-instruction">
											{hist.instruction}
										</div>
									</div>
								{/each}
							</div>
						{/if}
						{#each dialogues as dialogue, index}
							<div class="dialogue-item">
								<div class="speaker-label {dialogue.speaker}">
									{#if dialogue.speaker === 'speaker1'}
										{currentJobMetadata?.speaker1?.name || '話者1'}
									{:else if dialogue.speaker === 'speaker2'}
										{currentJobMetadata?.speaker2?.name || '話者2'}
									{:else if dialogue.speaker === 'metan'}
										四国めたん
									{:else if dialogue.speaker === 'zundamon'}
										ずんだもん
									{:else}
										{dialogue.speaker}
									{/if}
								</div>
								{#if editingDialogue}
									<textarea 
										bind:value={dialogue.text}
										class="dialogue-text-edit"
										rows="2"
									></textarea>
									<button 
										class="remove-btn" 
										on:click={() => removeDialogueItem(slideKey, index)}
									>
										✕
									</button>
								{:else}
									<div class="dialogue-text">{dialogue.text}</div>
								{/if}
							</div>
						{/each}
						{#if editingDialogue}
							<button 
								class="add-dialogue-btn" 
								on:click={() => addDialogueItem(slideKey)}
							>
								＋ セリフを追加
							</button>
						{/if}
					</div>
				{/each}
			</div>
		</section>
	{:else if currentJob}
		<section class="progress-section">
			<div class="job-info">
				<h3>{currentStep === 'video' ? '動画生成中...' : '対話スクリプト生成中...'}</h3>
				<div class="job-id">Job ID: {currentJob.job_id}</div>
				
				<div class="progress-bar">
					<div 
						class="progress-fill" 
						style="width: {currentJob.progress}%"
					></div>
				</div>
				
				<div class="status-info">
					<div class="status">ステータス: {currentJob.status}</div>
					<div class="progress-text">{currentJob.progress}% 完了</div>
				</div>

				{#if currentJob.message}
					<div class="message">{currentJob.message}</div>
				{/if}

				{#if currentJob.error}
					<div class="error">❌ {currentJob.error}</div>
				{/if}

				{#if currentJob.status === 'completed' && currentJob.result_url}
					<div class="result">
						<h4>✅ 動画生成完了！</h4>
						<div class="download-section">
							<a 
								href={getApiUrl(currentJob.result_url)} 
								download 
								class="download-btn"
							>
								📥 動画をダウンロード
							</a>
							<video controls class="preview-video">
								<source src={getApiUrl(currentJob.result_url)} type="video/mp4">
								お使いのブラウザは動画再生に対応していません。
							</video>
						</div>
						<div class="action-buttons">
							<button 
								class="back-to-script-btn" 
								on:click={() => {
									if (currentJob && dialogueData) {
										currentStep = 'dialogue';
									}
								}}
							>
								📝 スクリプトに戻る
							</button>
						</div>
					</div>
				{/if}

				<button class="new-job-btn" on:click={resetForm}>
					新しい動画を作成
				</button>
			</div>
		</section>
	{/if}
</main>

<style>
	.container {
		max-width: 1000px;
		margin: 0 auto;
		padding: 2rem;
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
	}

	header {
		text-align: center;
		margin-bottom: 3rem;
	}

	header h1 {
		font-size: 2.5rem;
		color: #2563eb;
		margin-bottom: 0.5rem;
	}

	header p {
		color: #6b7280;
		font-size: 1.1rem;
	}

	.upload-section {
		margin-bottom: 2rem;
	}

	.dropzone {
		border: 2px dashed #d1d5db;
		border-radius: 12px;
		padding: 3rem;
		text-align: center;
		transition: all 0.3s ease;
		background-color: #f9fafb;
	}

	.dropzone:hover, .dropzone.dragover {
		border-color: #2563eb;
		background-color: #eff6ff;
	}

	.upload-icon {
		font-size: 3rem;
		margin-bottom: 1rem;
	}

	.file-input {
		display: none;
	}

	.file-label {
		display: inline-block;
		background-color: #2563eb;
		color: white;
		padding: 0.75rem 1.5rem;
		border-radius: 8px;
		cursor: pointer;
		transition: background-color 0.3s ease;
		margin-top: 1rem;
	}

	.file-label:hover {
		background-color: #1d4ed8;
	}

	.file-info {
		margin-top: 2rem;
		padding: 1.5rem;
		background-color: #f3f4f6;
		border-radius: 8px;
	}

	.file-details {
		margin-bottom: 1rem;
		color: #374151;
	}

	.generate-btn {
		background-color: #10b981;
		color: white;
		border: none;
		padding: 0.75rem 1.5rem;
		border-radius: 8px;
		cursor: pointer;
		font-size: 1rem;
		margin-right: 1rem;
		transition: background-color 0.3s ease;
	}

	.generate-btn:hover {
		background-color: #059669;
	}

	.generate-btn:disabled {
		background-color: #9ca3af;
		cursor: not-allowed;
	}

	.reset-btn, .new-job-btn {
		background-color: #6b7280;
		color: white;
		border: none;
		padding: 0.75rem 1.5rem;
		border-radius: 8px;
		cursor: pointer;
		font-size: 1rem;
		transition: background-color 0.3s ease;
	}

	.reset-btn:hover, .new-job-btn:hover {
		background-color: #4b5563;
	}

	/* 対話編集セクション */
	.dialogue-section {
		max-width: 100%;
	}

	.duration-estimate {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		background-color: #e0f2fe;
		padding: 0.75rem 1rem;
		border-radius: 8px;
		margin-bottom: 1.5rem;
		border: 1px solid #7dd3fc;
	}

	.duration-icon {
		font-size: 1.25rem;
	}

	.duration-text {
		color: #0369a1;
		font-size: 1rem;
	}

	.duration-text strong {
		font-weight: 600;
		color: #0c4a6e;
	}

	.dialogue-controls {
		display: flex;
		gap: 1rem;
		margin-bottom: 2rem;
	}

	.edit-btn {
		background-color: #3b82f6;
		color: white;
		border: none;
		padding: 0.75rem 1.5rem;
		border-radius: 8px;
		cursor: pointer;
		transition: background-color 0.3s ease;
	}

	.edit-btn:hover {
		background-color: #2563eb;
	}

	.csv-download-btn, .csv-upload-btn {
		background-color: #059669;
		color: white;
		border: none;
		padding: 0.75rem 1.5rem;
		border-radius: 8px;
		cursor: pointer;
		transition: background-color 0.3s ease;
	}

	.csv-download-btn:hover, .csv-upload-btn:hover {
		background-color: #047857;
	}

	.edit-notice {
		display: flex;
		align-items: flex-start;
		gap: 0.75rem;
		background-color: #fef3c7;
		border: 1px solid #fbbf24;
		padding: 1rem;
		border-radius: 8px;
		margin: 1rem 0;
	}

	.notice-icon {
		font-size: 1.25rem;
		flex-shrink: 0;
	}

	.notice-text {
		color: #92400e;
		font-size: 0.9rem;
		line-height: 1.5;
	}

	.notice-text strong {
		font-weight: 600;
	}

	.additional-prompt-section {
		background-color: #f3f4f6;
		padding: 1.5rem;
		border-radius: 8px;
		margin-bottom: 2rem;
	}

	.additional-prompt-section label {
		display: block;
		font-weight: bold;
		margin-bottom: 0.5rem;
		color: #374151;
	}

	.additional-prompt-section textarea {
		width: 100%;
		padding: 0.75rem;
		border: 1px solid #d1d5db;
		border-radius: 6px;
		resize: vertical;
		font-family: inherit;
		margin-bottom: 1rem;
	}

	.regenerate-btn {
		background-color: #8b5cf6;
		color: white;
		border: none;
		padding: 0.5rem 1rem;
		border-radius: 6px;
		cursor: pointer;
		transition: background-color 0.3s ease;
	}

	.regenerate-btn:hover {
		background-color: #7c3aed;
	}

	.regenerate-btn:disabled {
		background-color: #d1d5db;
		color: #9ca3af;
		cursor: not-allowed;
	}

	.regeneration-status {
		margin-top: 1rem;
		padding: 1rem;
		background-color: #f0f9ff;
		border: 1px solid #60a5fa;
		border-radius: 6px;
	}

	.status-message {
		font-size: 0.875rem;
		color: #1e40af;
		margin-bottom: 0.5rem;
	}

	.dialogue-list {
		max-height: 600px;
		overflow-y: auto;
		border: 1px solid #e5e7eb;
		border-radius: 8px;
		padding: 1rem;
		background-color: #ffffff;
	}

	.slide-dialogue {
		margin-bottom: 2rem;
		padding-bottom: 1rem;
		border-bottom: 1px solid #e5e7eb;
	}

	.slide-dialogue:last-child {
		border-bottom: none;
	}

	.slide-header {
		display: flex;
		align-items: center;
		gap: 1rem;
		margin-bottom: 1rem;
		position: relative;
	}

	.slide-thumbnail {
		width: 150px;
		height: auto;
		border-radius: 6px;
		border: 1px solid #e5e7eb;
		box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
	}

	.slide-dialogue h4 {
		color: #1f2937;
		text-transform: capitalize;
	}

	.dialogue-item {
		display: flex;
		align-items: flex-start;
		margin-bottom: 0.75rem;
		gap: 0.75rem;
	}

	.speaker-label {
		min-width: 100px;
		padding: 0.25rem 0.75rem;
		border-radius: 4px;
		font-size: 0.875rem;
		font-weight: bold;
	}

	.speaker-label.metan {
		background-color: #fef3c7;
		color: #92400e;
	}

	.speaker-label.zundamon {
		background-color: #d1fae5;
		color: #065f46;
	}

	.dialogue-text {
		flex: 1;
		padding: 0.5rem;
		background-color: #f9fafb;
		border-radius: 6px;
		line-height: 1.5;
	}

	.dialogue-text-edit {
		flex: 1;
		padding: 0.5rem;
		border: 1px solid #d1d5db;
		border-radius: 6px;
		resize: vertical;
		font-family: inherit;
	}

	.remove-btn {
		background-color: #ef4444;
		color: white;
		border: none;
		padding: 0.25rem 0.5rem;
		border-radius: 4px;
		cursor: pointer;
		font-size: 0.875rem;
	}

	.remove-btn:hover {
		background-color: #dc2626;
	}

	.add-dialogue-btn {
		background-color: #f3f4f6;
		color: #4b5563;
		border: 1px dashed #9ca3af;
		padding: 0.5rem 1rem;
		border-radius: 6px;
		cursor: pointer;
		width: 100%;
		margin-top: 0.5rem;
		transition: all 0.3s ease;
	}

	.add-dialogue-btn:hover {
		background-color: #e5e7eb;
		border-color: #6b7280;
	}

	/* 進捗セクション */
	.progress-section {
		text-align: center;
	}

	.job-info {
		background-color: #f9fafb;
		padding: 2rem;
		border-radius: 12px;
		border: 1px solid #e5e7eb;
	}

	.job-id {
		font-family: monospace;
		color: #6b7280;
		margin-bottom: 1.5rem;
	}

	.progress-bar {
		width: 100%;
		height: 1rem;
		background-color: #e5e7eb;
		border-radius: 6px;
		overflow: hidden;
		margin: 1rem 0;
	}

	.progress-fill {
		height: 100%;
		background-color: #2563eb;
		transition: width 0.3s ease;
	}

	.status-info {
		display: flex;
		justify-content: space-between;
		margin-bottom: 1rem;
		color: #374151;
	}

	.message {
		background-color: #dbeafe;
		color: #1e40af;
		padding: 0.75rem;
		border-radius: 6px;
		margin: 1rem 0;
	}

	.error {
		background-color: #fee2e2;
		color: #dc2626;
		padding: 0.75rem;
		border-radius: 6px;
		margin: 1rem 0;
	}

	.result {
		margin-top: 2rem;
	}

	.download-section {
		margin-top: 1rem;
	}

	.download-btn {
		display: inline-block;
		background-color: #10b981;
		color: white;
		text-decoration: none;
		padding: 0.75rem 1.5rem;
		border-radius: 8px;
		margin-bottom: 1rem;
		transition: background-color 0.3s ease;
	}

	.download-btn:hover {
		background-color: #059669;
	}

	.preview-video {
		width: 100%;
		max-width: 600px;
		margin-top: 1rem;
		border-radius: 8px;
	}

	.new-job-btn {
		margin-top: 2rem;
	}

	.action-buttons {
		display: flex;
		gap: 1rem;
		justify-content: center;
		margin-top: 1.5rem;
	}

	.back-to-script-btn {
		background-color: #3b82f6;
		color: white;
		border: none;
		padding: 0.75rem 1.5rem;
		border-radius: 8px;
		cursor: pointer;
		font-size: 1rem;
		transition: background-color 0.3s ease;
	}

	.back-to-script-btn:hover {
		background-color: #2563eb;
	}

	/* 目安時間設定スタイル */
	.duration-setting {
		margin: 1rem 0;
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.duration-setting label {
		font-weight: 500;
		color: #374151;
	}

	.duration-setting input {
		width: 80px;
		padding: 0.5rem;
		border: 1px solid #d1d5db;
		border-radius: 6px;
		font-size: 1rem;
		text-align: center;
	}

	.duration-setting span {
		color: #6b7280;
	}

	/* キャラクター設定スタイル */
	.speaker-settings {
		margin: 1.5rem 0;
		padding: 1rem;
		background-color: #f9fafb;
		border-radius: 8px;
		border: 1px solid #e5e7eb;
	}

	.speaker-settings h4 {
		margin: 0 0 1rem 0;
		color: #374151;
		font-size: 1.1rem;
	}

	.speaker-row {
		display: flex;
		align-items: center;
		gap: 1rem;
		margin-bottom: 0.75rem;
	}

	.speaker-row:last-child {
		margin-bottom: 0;
	}

	.speaker-row label {
		min-width: 150px;
		font-weight: 500;
		color: #374151;
	}

	.speaker-row select {
		flex: 1;
		padding: 0.5rem;
		border: 1px solid #d1d5db;
		border-radius: 6px;
		font-size: 1rem;
		background-color: white;
		cursor: pointer;
	}

	.speaker-row select:hover {
		border-color: #9ca3af;
	}

	.speaker-row select:focus {
		outline: none;
		border-color: #2563eb;
		box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
	}
	
	.recommendation-toggle {
		background-color: #f3f4f6;
		color: #1f2937;
		border: 1px solid #d1d5db;
		padding: 0.5rem 1rem;
		border-radius: 6px;
		cursor: pointer;
		margin-bottom: 1rem;
		transition: all 0.2s ease;
		font-weight: 500;
	}
	
	.recommendation-toggle:hover {
		background-color: #e5e7eb;
		border-color: #9ca3af;
	}
	
	.recommendations {
		background-color: #f0f9ff;
		border: 1px solid #3b82f6;
		border-radius: 8px;
		padding: 1rem;
		margin-bottom: 1.5rem;
	}
	
	.recommendations h5 {
		margin: 0 0 1rem 0;
		color: #1e40af;
		font-size: 1rem;
	}
	
	.recommendation-item {
		background-color: white;
		border: 1px solid #dbeafe;
		border-radius: 6px;
		padding: 0.75rem;
		margin-bottom: 0.75rem;
	}
	
	.recommendation-item:last-child {
		margin-bottom: 0;
	}
	
	.rec-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 0.5rem;
	}
	
	.rec-header strong {
		color: #1f2937;
		font-size: 0.95rem;
	}
	
	.apply-btn {
		background-color: #3b82f6;
		color: white;
		border: none;
		padding: 0.25rem 0.75rem;
		border-radius: 4px;
		cursor: pointer;
		font-size: 0.875rem;
		transition: background-color 0.2s ease;
	}
	
	.apply-btn:hover {
		background-color: #2563eb;
	}
	
	.rec-description {
		color: #6b7280;
		font-size: 0.875rem;
		margin: 0 0 0.25rem 0;
	}
	
	.rec-speakers {
		color: #374151;
		font-size: 0.875rem;
		margin: 0;
	}
	
	.sample-btn {
		background-color: #10b981;
		color: white;
		border: none;
		padding: 0.5rem;
		border-radius: 6px;
		cursor: pointer;
		font-size: 1rem;
		transition: all 0.2s ease;
		width: 40px;
		height: 40px;
		display: flex;
		align-items: center;
		justify-content: center;
	}
	
	.sample-btn:hover {
		background-color: #059669;
		transform: scale(1.05);
	}
	
	.sample-btn:active {
		transform: scale(0.95);
	}
	
	.sample-btn:disabled {
		background-color: #9ca3af;
		cursor: not-allowed;
		transform: none;
	}
	
	.sample-btn.loading {
		background-color: #6b7280;
	}
	
	.spinner {
		display: inline-block;
		width: 16px;
		height: 16px;
		border: 2px solid rgba(255, 255, 255, 0.3);
		border-top-color: white;
		border-radius: 50%;
		animation: spin 0.8s linear infinite;
	}
	
	@keyframes spin {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
	}
	
	select:disabled,
	button:disabled {
		opacity: 0.6;
		cursor: not-allowed;
	}

	/* 指示履歴スタイル */
	.history-toggle {
		background-color: #e0f2fe;
		color: #0369a1;
		border: 1px solid #7dd3fc;
		padding: 0.25rem 0.75rem;
		border-radius: 6px;
		font-size: 0.875rem;
		cursor: pointer;
		transition: all 0.2s ease;
		margin-left: auto;
	}

	.history-toggle:hover {
		background-color: #bae6fd;
		border-color: #38bdf8;
	}

	.instruction-history {
		background-color: #f0f9ff;
		border: 1px solid #bae6fd;
		border-radius: 8px;
		padding: 1rem;
		margin: 1rem 0;
	}

	.instruction-history h5 {
		margin: 0 0 0.75rem 0;
		color: #0369a1;
		font-size: 0.9rem;
		font-weight: 600;
	}

	.history-item {
		background-color: white;
		border: 1px solid #e0e7ff;
		border-radius: 6px;
		padding: 0.75rem;
		margin-bottom: 0.5rem;
	}

	.history-item:last-child {
		margin-bottom: 0;
	}

	.history-timestamp {
		font-size: 0.75rem;
		color: #6b7280;
		margin-bottom: 0.25rem;
	}

	.history-instruction {
		color: #1f2937;
		font-size: 0.875rem;
		line-height: 1.5;
	}
</style>